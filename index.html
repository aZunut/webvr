<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-hand-tracking-controls@3.3.0/dist/aframe-hand-tracking-controls.min.js"></script>
  </head>
  <body>
    <a-scene xr-mode="true">
      <!-- 球体 -->
      <a-sphere id="movable-sphere" position="0 1 -3" radius="0.3" color="blue"></a-sphere>

      <!-- ハンドトラッキングのコントローラー -->
      <a-entity id="left-hand" hand-tracking-controls="hand: left"></a-entity>
      <a-entity id="right-hand" hand-tracking-controls="hand: right"></a-entity>

      <a-camera position="0 1.6 0"></a-camera>
    </a-scene>

    <script>
      const joints = [
        "wrist", "thumb-tip", "index-finger-tip", "middle-finger-tip", "ring-finger-tip", "pinky-finger-tip"
      ];
      let lastTime = performance.now();
      let fps = 0;
      let dragging = false;
      let grabbedHand = null;

      function calculateFPS() {
        const currentTime = performance.now();
        fps = 1000 / (currentTime - lastTime);
        lastTime = currentTime;
        console.log("FPS: " + fps.toFixed(2));
      }

      function logJointData(hand, jointName, position) {
        console.log(`${hand} - ${jointName}: (${position.x.toFixed(3)}, ${position.y.toFixed(3)}, ${position.z.toFixed(3)})`);
      }

      function moveSphere(position) {
        const sphere = document.getElementById("movable-sphere");
        sphere.setAttribute("position", `${position.x} ${position.y} ${position.z}`);
      }

      AFRAME.registerComponent("track-hands", {
        tick: function () {
          calculateFPS();

          ["left-hand", "right-hand"].forEach((handId) => {
            const handEl = document.getElementById(handId);
            if (handEl) {
              const hand = handEl.components["hand-tracking-controls"].controller;
              if (hand) {
                joints.forEach((jointName) => {
                  const joint = hand.joints[jointName];
                  if (joint) {
                    logJointData(handId, jointName, joint.position);
                    if (!dragging && jointName === "index-finger-tip" && !grabbedHand) {
                      const spherePos = document.getElementById("movable-sphere").getAttribute("position");
                      const distance = Math.sqrt(
                        Math.pow(joint.position.x - spherePos.x, 2) +
                        Math.pow(joint.position.y - spherePos.y, 2) +
                        Math.pow(joint.position.z - spherePos.z, 2)
                      );
                      if (distance < 0.4) {
                        dragging = true;
                        grabbedHand = handId;
                      }
                    }
                    if (dragging && handId === grabbedHand && jointName === "index-finger-tip") {
                      moveSphere(joint.position);
                    }
                  }
                });
              }
            }
          });

          if (dragging && !grabbedHand) {
            dragging = false;
          }
        },
      });

      document.querySelector("a-scene").setAttribute("track-hands", "");
    </script>
  </body>
</html>
